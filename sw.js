const CACHE_NAME="story-app-v1",getBasePath=()=>{const e=self.location.pathname;if(console.log("[SW] Service Worker pathname:",e),e.includes("/Tugas-intermediate-idelia-fk/"))return"/Tugas-intermediate-idelia-fk";const t=e.split("/").filter((e=>e&&"sw.js"!==e&&""!==e));return t.length>0?"/"+t.join("/"):""};let APP_SHELL=[];self.addEventListener("install",(e=>{console.log("[SW] Install event - Caching App Shell");const t=getBasePath();console.log("[SW] Base path:",t);const n=[`${t}/index.html`,`${t}/app.css`,`${t}/app.bundle.js`,`${t}/favicon.png`,`${t}/images/logo.png`,`${t}/manifest.json`];e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("[SW] Caching App Shell files:",n),Promise.allSettled(n.map((t=>fetch(t).then((n=>n.ok?e.put(t,n):(console.warn(`[SW] Failed to cache ${t}: HTTP ${n.status}`),null))).catch((e=>(console.warn(`[SW] Failed to cache ${t}:`,e.message),null))))))))).then((e=>{const t=e.filter((e=>"fulfilled"===e.status&&null!==e.value)).length;console.log(`[SW] App Shell cached: ${t}/${n.length} files`)})).catch((e=>{console.error("[SW] Cache install error:",e)}))),self.skipWaiting()})),self.addEventListener("activate",(e=>(console.log("[SW] Activate event"),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME)return console.log("[SW] Deleting old cache:",e),caches.delete(e)})))))),self.clients.claim()))),self.addEventListener("fetch",(e=>{const{request:t}=e,n=new URL(t.url);"GET"===t.method&&(n.pathname.startsWith("/v1/stories")||n.pathname.includes("/stories")?e.respondWith(fetch(t).then((e=>{const n=e.clone();return e.ok&&caches.open(CACHE_NAME).then((e=>{e.put(t,n)})),e})).catch((()=>caches.match(t).then((e=>e||new Response(JSON.stringify({error:!0,message:"Offline: Data tidak tersedia"}),{headers:{"Content-Type":"application/json"}})))))):(t.headers.get("accept")||"").includes("text/html")?e.respondWith(fetch(t).then((e=>{if(e&&200===e.status){const n=e.clone();caches.open(CACHE_NAME).then((e=>{e.put(t,n)}))}return e})).catch((()=>{const e=getBasePath();return console.log("[SW] Offline - returning cached App Shell from:",`${e}/index.html`),caches.match(`${e}/index.html`).then((t=>t?(console.log("[SW] Found cached index.html"),t):caches.match(`${e}/`).then((e=>e?(console.log("[SW] Found cached root"),e):caches.match("/index.html").then((e=>e?(console.log("[SW] Found cached root index.html"),e):(console.warn("[SW] No cached App Shell found"),new Response("<!DOCTYPE html><html><head><title>Offline</title></head><body><h1>Aplikasi sedang offline</h1><p>Silakan cek koneksi internet Anda.</p></body></html>",{status:200,headers:{"Content-Type":"text/html; charset=utf-8"}}))))))))}))):e.respondWith(caches.match(t).then((e=>e||fetch(t).then((e=>{if(!e||200!==e.status||"basic"!==e.type)return e;const n=e.clone();return caches.open(CACHE_NAME).then((e=>{e.put(t,n)})).catch((()=>{})),e})).catch((()=>caches.match(t)))))))})),self.addEventListener("push",(e=>{console.log("[SW] Push notification received");let t={};if(e.data)try{t=e.data.json()}catch(n){t={title:"Story App",body:e.data.text()}}const n=getBasePath(),a=n?`${n}/images/logo.png`:"/images/logo.png",o=t.title||t.notification?.title||"Story App",i=t.body||t.notification?.body||t.message||"Anda mendapat notifikasi baru",s=t.icon||t.notification?.icon||a,c=t.image||t.notification?.image,l={body:i,icon:s,badge:t.badge||a,image:c,data:t.data||t||{},tag:t.tag||"story-notification",requireInteraction:t.requireInteraction||!1,timestamp:t.timestamp||Date.now(),vibrate:t.vibrate||[200,100,200],actions:t.actions||(t.data?.storyId?[{action:"view",title:"Lihat Detail",icon:a},{action:"close",title:"Tutup"}]:[])};e.waitUntil(self.registration.showNotification(o,l))})),self.addEventListener("notificationclick",(e=>{console.log("[SW] Notification clicked:",e),e.notification.close();const t=e.notification.data,n=getBasePath(),a=n?`${n}/#/home`:"/#/home";if("view"===e.action&&t.storyId)e.waitUntil(clients.openWindow(`${a}?storyId=${t.storyId}`));else{if("close"===e.action)return;t.storyId?e.waitUntil(clients.openWindow(`${a}?storyId=${t.storyId}`)):e.waitUntil(clients.openWindow(a))}}));